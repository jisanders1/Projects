# Lox: Bytecode Implementation in C
Jaylon Sanders: CS 403

This folder containts the workings of a Lox interpreter via a virtual machine in C. I used the book [_Crafting Interpreters_](https://www.craftinginterpreters.com/) and modified the code slightly. These modifications often included changing names where I feel a more understandable name could be used, switching switch statements for if statements and vice-versa, and switching some for loops to while loops where applicable. Additionally, I ran several test cases that were provided in the text, and will be running several of the test cases found in the [books' repository](https://github.com/munificent/craftinginterpreters/tree/master/test).

## Compiling
In order to run the program, you should first make sure that you have the ability to compile and run C code. If you are running a Linux based system, then there is a high chance that it is already installed on your computer. If you are using a Windows, you should install the MinGW compiler (for instructions to compile go [here](https://www.geeksforgeeks.org/installing-mingw-tools-for-c-c-and-changing-environment-variable/])). After this step, you should clone this repository to a directory of your choice.

Before you compile the program, you should verify which debug flags you wish to enable.
```
DEBUG_PRINT_CODE - Enables printing of the bytecode generated by the compiler.
DEBUG_TRACE_EXECUTION - Enables the printing of the stack of values along with each op code.
``` 
In order to enable the debug flags, un-comment the following lines of the file ```common.h```. If you do not wish to generate these extra output (this extra output could make it difficult to see the output of the REPL especially), leave them commented.
```
DEBUG_PRINT_CODE - Line 10
DEBUG_TRACE_EXECUTION - Line 14
```

For reference here is the content that each flag may output. There is one example of each, but the length and output with most likely vary from Lox program to Lox program.
1. ```DEBUG_PRINT_CODE```
```
== code ==
0000   10 CONSTANT_OP         1 'cafe au lait'
0002    | DEFINE_GLOBAL_OP    0 'beverage'
0004   11 CONSTANT_OP         3 'beignets with '
0006    | GET_GLOBAL_OP       4 'beverage'
0008    | ADD_OP
0009    | DEFINE_GLOBAL_OP    2 'breakfast'
0011   12 GET_GLOBAL_OP       5 'breakfast'
0013    | PRINT_OP
0014   15 CONSTANT_OP         7 'beignets'
0016    | DEFINE_GLOBAL_OP    6 'breakfast'
0018   16 CONSTANT_OP         9 'cafe au lait'
0020    | DEFINE_GLOBAL_OP    8 'beverage'
0022   17 CONSTANT_OP        11 'beignets with '
0024    | GET_GLOBAL_OP      12 'beverage'
0026    | ADD_OP
0027    | SET_GLOBAL_OP      10 'breakfast'
0029    | POP_OP
0030   19 GET_GLOBAL_OP      13 'breakfast'
0032    | PRINT_OP
0033    | RETURN_OP

```

2. ```DEBUG_TRACE_EXECUTION``
```
Val Stack: 

0000   10 CONSTANT_OP         1 'cafe au lait'
Val Stack: [ cafe au lait ]

0002    | DEFINE_GLOBAL_OP    0 'beverage'
Val Stack:

0004   11 CONSTANT_OP         3 'beignets with '
Val Stack: [ beignets with  ]

0006    | GET_GLOBAL_OP       4 'beverage'
Val Stack: [ beignets with  ][ cafe au lait ]

0008    | ADD_OP
Val Stack: [ beignets with cafe au lait ]

0009    | DEFINE_GLOBAL_OP    2 'breakfast'
Val Stack:

0011   12 GET_GLOBAL_OP       5 'breakfast'
Val Stack: [ beignets with cafe au lait ]

0013    | PRINT_OP
beignets with cafe au lait
Val Stack:

0014   15 CONSTANT_OP         7 'beignets'
Val Stack: [ beignets ]

0016    | DEFINE_GLOBAL_OP    6 'breakfast'
Val Stack:

0018   16 CONSTANT_OP         9 'cafe au lait'
Val Stack: [ cafe au lait ]

0020    | DEFINE_GLOBAL_OP    8 'beverage'
Val Stack:

0022   17 CONSTANT_OP        11 'beignets with '
Val Stack: [ beignets with  ]

0024    | GET_GLOBAL_OP      12 'beverage'
Val Stack: [ beignets with  ][ cafe au lait ]

0026    | ADD_OP
Val Stack: [ beignets with cafe au lait ]

0027    | SET_GLOBAL_OP      10 'breakfast'
Val Stack: [ beignets with cafe au lait ]

0029    | POP_OP
Val Stack:

0030   19 GET_GLOBAL_OP      13 'breakfast'
Val Stack: [ beignets with cafe au lait ]

0032    | PRINT_OP
beignets with cafe au lait
Val Stack:

0033    | RETURN_OP

```

Finally, navigate to the ```Sources``` folder and enter (I would copy and paste if I were you) the following line of code to compile the source files:
```
gcc chunk.c debug.c main.c memory.c value.c vm.c compiler.c scanner.c object.c table.c -o clox
```
## Running
After you enter this command, the program sholud be compiled to an executable. In order to run the program, you should type invoke the executable file, which may end in ".exe" or ".out" for most. For Windows users, you should be able to type the following in the Command Prompt:
```
clox
```
or the following if using Cygwin:
```
./clox
```
This will launch the REPL (short for **_R_**eading a line of input, **_E_**valuating it, **_P_**rinting the result, then **_L_**ooping and repeating all four steps again) and allow a user to enter lines of code into the terminal and have their code executed. You can only enter a maximum of 1,024 characters per line. If you want to run code from a file, enter the following:
```
clox <filename>.lox
```
or if using Cygwin:
```
./clox <filename>.lox
```
If there is an error (attempting to open a non-existent file or directory, running out of memory, etc.), the program will report it. 

Currently, the program evaluates both normal and block statements. Additionally, the program can handle control flow, such as if-else statements, while loops, and for loops, These can involve both global and local variables. For example, you can run the clox program with a file that contains the following:
```
// Test 1: Check to make sure variable declaration is working.
var beverage = "cafe au lait";
var breakfast = "beignets with " + beverage;
print breakfast;

// Test 2: Verifying assignment works correctly.
var breakfast = "beignets";
var beverage = "cafe au lait";
breakfast = "beignets with " + beverage;

print breakfast;
```
This should output:

1. With only the ```DEBUG_TRACE_EXECUTION``` flag enabled:
```
Val Stack: 

0000   10 CONSTANT_OP         1 'cafe au lait'
Val Stack: [ cafe au lait ]

0002    | DEFINE_GLOBAL_OP    0 'beverage'
Val Stack:

0004   11 CONSTANT_OP         3 'beignets with '
Val Stack: [ beignets with  ]

0006    | GET_GLOBAL_OP       4 'beverage'
Val Stack: [ beignets with  ][ cafe au lait ]

0008    | ADD_OP
Val Stack: [ beignets with cafe au lait ]

0009    | DEFINE_GLOBAL_OP    2 'breakfast'
Val Stack:

0011   12 GET_GLOBAL_OP       5 'breakfast'
Val Stack: [ beignets with cafe au lait ]

0013    | PRINT_OP
beignets with cafe au lait
Val Stack:

0014   15 CONSTANT_OP         7 'beignets'
Val Stack: [ beignets ]

0016    | DEFINE_GLOBAL_OP    6 'breakfast'
Val Stack:

0018   16 CONSTANT_OP         9 'cafe au lait'
Val Stack: [ cafe au lait ]

0020    | DEFINE_GLOBAL_OP    8 'beverage'
Val Stack:

0022   17 CONSTANT_OP        11 'beignets with '
Val Stack: [ beignets with  ]

0024    | GET_GLOBAL_OP      12 'beverage'
Val Stack: [ beignets with  ][ cafe au lait ]

0026    | ADD_OP
Val Stack: [ beignets with cafe au lait ]

0027    | SET_GLOBAL_OP      10 'breakfast'
Val Stack: [ beignets with cafe au lait ]

0029    | POP_OP
Val Stack:

0030   19 GET_GLOBAL_OP      13 'breakfast'
Val Stack: [ beignets with cafe au lait ]

0032    | PRINT_OP
beignets with cafe au lait
Val Stack:

0033    | RETURN_OP
```

2. With only the ```DEBUG_PRINT_CODE``` flag enabled:
```
== code ==
0000   10 CONSTANT_OP         1 'cafe au lait'
0002    | DEFINE_GLOBAL_OP    0 'beverage'
0004   11 CONSTANT_OP         3 'beignets with '
0006    | GET_GLOBAL_OP       4 'beverage'
0008    | ADD_OP
0009    | DEFINE_GLOBAL_OP    2 'breakfast'
0011   12 GET_GLOBAL_OP       5 'breakfast'
0013    | PRINT_OP
0014   15 CONSTANT_OP         7 'beignets'
0016    | DEFINE_GLOBAL_OP    6 'breakfast'
0018   16 CONSTANT_OP         9 'cafe au lait'
0020    | DEFINE_GLOBAL_OP    8 'beverage'
0022   17 CONSTANT_OP        11 'beignets with '
0024    | GET_GLOBAL_OP      12 'beverage'
0026    | ADD_OP
0027    | SET_GLOBAL_OP      10 'breakfast'
0029    | POP_OP
0030   19 GET_GLOBAL_OP      13 'breakfast'
0032    | PRINT_OP
0033    | RETURN_OP
beignets with cafe au lait
beignets with cafe au lait
```

3. With no flags enabled:
```
beignets with cafe au lait
beignets with cafe au lait
```

In the last two cases, the output should be the last few lines of code, but in the first two cases, the output is nestled within the debug information. Due to this, I would highley recommend you to disable the ```DEBUG_TRACE_EXECUTION``` flag for more clarity in outputs. The program should also handle reporting errors in statements or errors that are inside of statements. If you attempt to enter an expression and not an expression statement (ie, you are missing a semicolon) into the REPL, such as ```1 + 2```, the program outputs: ```[line 2] Error at end: Expect ';' after expression.```. Entering an expression statement and not assigning it to a variable will evaluate it, but the result will not be stored nor printed.

## Progresion
You can find a copy of my code after each chapter in the ```Progression``` folder. To run these, you should unzip them to a location outside of this folder and complete the instructions from the [Compiling](https://github.com/jisanders1/Projects/tree/main/Programming%20Languages%20(CS%20403)/clox#compiling) and [Running](https://github.com/jisanders1/Projects/tree/main/Programming%20Languages%20(CS%20403)/clox#running) sections above. 

Chapter 14 - Chunks of Bytecode:
- Added basic functionality for encoding constant and return operations, and for encoding constants and values.
- Separated source and header files into two separate directories.
- Added ```.gitignore``` to not track any executables generated by the user.

Chapter 15 - A Virtual Machine:
- Added arithmetic operators and the ability to evaluate expressions.
- Updated ```.gitignore``` to not track additional compilation side effects (such as ```clox.exe.stackdump```).
- Updated and added comments above functions and wtihin them to detail what is happening.
- Made some changes to the debugger to more easily associate what is happening in the stack with the op codes.

Chapter 16 - Scanning on Demand:
- Added a scanner file, ```scanner.c```, that scans in source code from a either a file or the REPL. The REPL is an interactive command line program that allows users to enter a line of code and have it evaluated and executed. 
- Updated ```.gitignore``` to not track any Lox or Text files. This is so the repository looks cleaner.
- Got rid of old main in order to suppport the REPL and file reading features.
- Tested with some of my own test cases to ensure that error were being caught (opening a non-existent file, scanning an unterminated string, etc.). 

Chapter 17 - Compiling Expression:
- Added the ability to evaluate expressions involving numbers and the basic operators (addition, subtraction, multiplication, division).
- Added a new debug flag to print the bytecodes generated by the compiler.
- Compiler now evaluates expressions instead of printing the tokens to the terminal.

Chapter 18 - Types of Values:
- Added the ability to evaluate boolean and nil operators and print them in the debuggers.
- Arithmetic and boolean operators can now be chained together.

Chapter 19 - Strings:
- Added the ability to use strings in expressions for concatenation and comparison, as well as a base object class that can be used for other functionality later on.
- Set up cleanup for the storage used by string objects, although there is no garbage collection at the moment so all strings stick around until the program ends.

Chapter 20 - Hash Tables:
- Added a hash table module in order to implement assignment, function declarations, and class declarations in later chapters.
- Changed the way equality is checked with strings, instead of stepping through each character in the string, hash codes are used instead.
- Ran a REPL checking for string equality to ensure that the output is still correct.

Chapter 21 - Global Variables:
- Added the ability to define and assign global variables.
- Added the ability to print statements. Print statements print a newline with them by default.
- Entering expressions no longer will work, you must use a statement and follow it with a ';'.
- Tested the examples from this chapter through running a file with the test cases listed above in the [Running](https://github.com/jisanders1/Projects/tree/main/Programming%20Languages%20(CS%20403)/clox#running) section.

Chapter 22 - Local Variables:
- Added block statements with the ability to track the scope.
- With block statements, the differentiation between global and local variables was specified.
- Re-declaration of variables within the same scope and using a variable in its own initializer are not allowed.

Chapter 23 - Jumping Back and Forth:
- Added control flow to the program, including while loops, for loops, and if-else statements.
- Tested all of the different types of control flow with my own test cases.
- Decided that chapter 24 will be the last chapter that I am able to do for now due to time constraints.
- May consider showing a general example for how the debug flags look instead of providing 4 different version of the same program for each example.

## Issues
- The compilation process is a bit long. Perhaps making a makefile will reduce difficulty.
- Changing the books code is slightly difficult due to how rigid C requires its declarations to be. Additionally, I have found switching switch statements to if-else statement negatively impacts readability completely. I will keep the original switch statements for most of the code.